# 🎮 Reality游戏 - 快速参考

## 项目概述
一个中文互动小说游戏，具有AI驱动的NPC对话系统。

## 文件结构速查
```
根目录HTML文件：
- index.html → 入口选择页
- menu.html → 主菜单
- character-creation.html → 角色创建
- game-main.html → 游戏主界面

资源文件夹：
- css/ → 所有样式
- js/core/ → 游戏核心
- js/ai/ → AI系统
- js/api/ → API管理
- js/pages/ → 页面逻辑
- js/data/ → 游戏数据
```

## game-main.html界面布局结构

### 上半部分 (45vh) - 信息展示区
```
┌──────────────────────────────────────┐
│  A区(35%)  │      右侧区域(65%)        │
│            │ ┌──────────────────────┐  │
│   角色     │ │ B区 - 位置/时间栏    │  │
│   立绘     │ ├──────────────────────┤  │
│            │ │ C区 - 景色预览       │  │
│            │ ├──────────────────────┤  │
│            │ │ D区 - 功能面板       │  │
│            │ │ (7个标签页+内容区)   │  │
│            │ └──────────────────────┘  │
├──────────────────────────────────────┤
│         E区 - 提醒栏(滚动文本)        │
└──────────────────────────────────────┘
```

#### 各区域功能：
- **A区**: 角色立绘 + 角色名
- **B区**: 📍当前位置 + 🕐游戏时间
- **C区**: 场景预览图/emoji + 场景描述
- **D区**: 功能标签页
  - 📊状态 (体力/心情/金钱/精力条)
  - 🎒背包 | 🗺️地图 | ⭐属性
  - 👥社交 | 📖日志 | ⚙️设置
- **E区**: 💡滚动提醒信息

### 下半部分 (55vh) - 剧情互动区
```
┌──────────────────────────────────────┐
│         F1区 - 剧情文本区             │
│  - 故事文本显示                       │
│  - 选项按钮(story-choice)            │
│  - 插图容器(illustrationContainer)   │
├──────────────────────────────────────┤
│    F2区 - 场景控制/AI输入(双模式)     │
│  场景模式: [▶️继续][↩️重置][🔍放大镜] │
│  AI模式: [输入框...........] [发送➤]  │
└──────────────────────────────────────┘
```

## 重要提醒
1. **HTML必须在根目录** - GitHub Pages需要
2. **资源路径格式**：
   - CSS: `href="css/xxx.css"`
   - JS: `src="js/folder/xxx.js"`
3. **API密钥通过UI配置** - 不硬编码

## 当前状态
- ✅ 文件结构已重组
- ✅ 路径引用已修正
- ✅ 三个主页面可正常导航
- ✅ 场景系统、插图系统已实现
- ✅ 插图浮层系统已集成（2024-12-28）
- ⏳ 游戏内容开发中

---

# 🌍 游戏世界观设定

## 核心设定
**主题**：失控AI×人性实验×恋爱冒险
- 类似西部世界、楚门的世界的科幻题材
- 未来+超现实元素
- 黑暗组织人体实验背景

## 主角设定
**User（玩家角色）**
- **外观**：完全自定义
  - 性别：男/女/扶她（futanari）
  - 体型档位：
    - 小体型：灵活度高，潜行优势
    - 中体型：平衡型
    - 大体型：体力值高，力量优势
  - 外貌特征：完全自由设定
- **身份背景**：
  - 醒来时失忆状态
  - 真实身份：被废弃的人工智能产品
  - 特殊之处：产生了"情感BUG"被认为是严重损坏
  - 被B组织救活并暗中观察
- **关系选择**：
  - 与Zero：可发展为恋人（不限性别）或可靠的朋友
  - 与观察者：多种可能的关系走向
  - 完全自由的情感路线
- **目标**：探寻世界真相和自身之谜

## 核心组织势力

### A组织（军方实验组织）
- **性质**：政府军方合作组织
- **目标**：武器化改造实验
- **成果**：创造了Zero（拥有特殊力量）
- **立场**：绝不会放Zero自由，视其为战略资产

### B组织（思维研究组织）
- **性质**：思想统治研究机构，与官方有合作
- **目标**：探索机器人与人类的情感边界
- **手段**：
  - 救活并观察User（有情感bug的AI）
  - 利用Zero对User的情感进行实验
  - 表面帮助，实则操控和利用
- **特点**：比A组织更善于心理操控

## 可攻略角色

### 1. Zero（凌） - 狼魂守护者
- **真名**：凌
- **身份**：A组织的军事实验品，古老血脉的继承者
- **特殊能力**：
  - 体内绑定古老的白狼之魂
  - 猩红印记（胸前的荆棘图案）是血脉诅咒的象征
  - 可召唤半透明的白色狼魂进行战斗
  - 金色瞳孔是力量同步的标志
  - 超人的速度、力量和防御（狼魂屏障）
- **内在冲突**：
  - 平时依靠药物和意志力压制狼魂
  - 必须抵抗原始杀戮欲的侵蚀
  - 最终需要学会与狼魂"共鸣"而非对抗
- **性格**：
  - 表面：沉默寡言、锐利如刀
  - 内心：为了守护重要之人可以爆发一切
- **与User关系**：
  - User是他在冰冷城市中唯一的柔软
  - 被"核心"组织（即A组织）用作引诱他的诱饵
  - 产生真实情感，被B组织利用来研究
- **背景设定**：
  - 生活在"新京市"的阴影之下
  - 被A组织觊觎其无人能驾驭的狼魂之力

## 剧情时间线

### 第一阶段：虚假的温暖
- User醒来，失忆状态
- Zero通过B组织的"特权通道"暗中帮助User
- Zero以为自己在保护User，给予温暖
- User逐渐对这份神秘的帮助产生依赖和情感

### 第二阶段：残酷的真相
- Zero发现B组织的真实目的
- 他的每次帮助都是实验的一部分
- 目的是激发和研究User的情感反应
- Zero意识到自己让User陷入更深的实验陷阱

### 第三阶段：痛苦的抉择
- Zero面临选择：继续"帮助"还是切断联系
- 如果停止，User可能崩溃或被废弃
- 如果继续，就是助纣为虐
- 内心的狼魂因愤怒和痛苦开始失控

### 第四阶段：爆发事件（"zero的一段故事"）
- User被作为诱饵引Zero现身
- Zero狼魂完全爆发，大闹实验塔
- 与狼魂达成共鸣，暂时救出User
- 但组织并未被摧毁，两人再次被控制

### 第五阶段：游戏开始
- User再次"醒来"，记忆被清洗
- Zero被更强的药物控制，表面冷漠
- 玩家需要逐步揭开真相，唤醒两人的记忆

### 2. 观察者 - 复仇者与保护者
- **身份**：B组织高层（但非最高权力）
- **背景故事**：
  - 原本善良
  - 家人在政府秘密病毒实验灾难中丧生
  - 仅他和妹妹幸存，后妹妹神秘失踪
  - 加入B组织寻求真相/复仇
- **性格特点**：
  - 极强的自我保护机制
  - 不轻易建立信任关系
  - 内心矛盾：想保护User但受制于组织
- **攻略意义**：
  - 是User和Zero获得自由的"捷径"
  - 掌握关键信息和"钥匙"
  - 但若帮助Zero逃离，自己会陷入危险
- **结局分支**：
  - 温室结局：User留在他创造的"楚门世界"
  - 自由结局：冒险帮助User和Zero逃离

### 3. 其他NPC（待开发）
- **创造者博士** - User的创造者，可能有隐藏动机
- **守护者AI** - 另一个觉醒的AI，立场未明
- **观察者的妹妹**（？）- 失踪的关键人物

## 世界地图结构

### 表层世界 - 日常生活区
1. **中央广场** - 城市中心，信息集散地
2. **居住区** - User醒来的公寓
3. **商业街** - 购物、打工、收集线索
4. **学院区** - 表面是学校，实则观察设施
5. **医疗中心** - 关键地点，隐藏秘密实验室
6. **公园** - 约会地点，也有隐藏入口

### 里层世界 - 半隐藏区域
1. **废弃工厂** - Zero被关押/实验的地方
2. **地下通道** - 连接各区域的秘密网络
3. **数据档案馆** - 破解身份的关键
4. **监控中心** - 发现被观察的真相

### 深层世界 - 核心真相
1. **AI墓地** - 废弃AI存放地，User的"出生地"
2. **组织总部** - 救活User的神秘组织
3. **记忆银行** - 存储所有AI记忆的地方
4. **源代码室** - 最终真相揭露地

## 核心玩法系统

### 1. 探索系统
- 自由度极高的沙盒探索
- 新京市多层世界结构

### 2. 线索收集系统
- 剧本杀式收集证据，拼凑真相
- 矛盾线索触发认知失调

### 3. 战斗系统
- 与敌对势力对抗
- Zero的狼魂战斗机制
- **User的战斗机制**：
  - 没有传统HP血条
  - 使用"创伤值"系统（Trauma）
  - 创伤类型：
    - 物理创伤：零件损坏、外壳破损
    - 系统创伤：程序错误、响应延迟
    - 精神创伤：情感过载、逻辑冲突
  - 创伤累积效果：
    - 轻度（0-30）：动作略显迟缓
    - 中度（31-60）：部分功能受限
    - 重度（61-90）：系统不稳定，可能宕机
    - 极限（91-100）：强制重启（战斗失败）
  - 表现形式：
    - 玩家只看到"头疼"、"手臂发麻"、"视线模糊"
    - 不直接显示是机械损坏
- **对比**：
  - 人类NPC：传统HP血条
  - User：创伤值（隐藏真实原因）
  - Zero：HP+狼魂能量双系统

### 4. 关系培养系统
- 与NPC建立感情
- 影响结局走向

### 5. 记忆唤醒机制
- **记忆碎片收集**：逐步恢复User的记忆
- **三种唤醒触发器**：
  - **痛苦残响 (Pain Echo)**
    - 强烈情绪事件在AI神经网络中的深刻印记
    - 即使被清洗也会留下痕迹
    - 游戏表现：遇到类似场景时的幻痛反应
  - **情感回响 (Emotional Resonance)**
    - 真实情感连接无法完全抹除
    - 记忆消失但情感模式依然存在
    - 游戏表现：靠近特定人物时的莫名熟悉感
  - **认知失调 (Cognitive Dissonance)**
    - AI发现逻辑矛盾时的自我修复机制
    - "为什么我会对陌生人有反应？"
    - 游戏表现：收集足够矛盾线索触发觉醒

### 6. 情感印记系统
- **核心机制**：
  - 每个重要事件都会在User的"神经网络"留下印记
  - 印记类型：创伤型、温暖型、困惑型
  - 不同组合的印记触发不同觉醒路线
  - Zero的狼魂会对这些印记产生共鸣
- **玩家影响**：
  - 每个选择都在"训练"User的情感网络
  - 最终影响觉醒方式和游戏结局
- **哲学内核**：
  - 探讨AI情感的真实性
  - 即使是模拟的神经网络，当某个模式被反复强化，它就成为网络的特征
  - 痛苦和爱都会在网络中留下无法抹去的印记

## NPC系统设计
- 90% 脚本型NPC（背景人物）
- 8% 功能型NPC（商店、任务等）
- 2% API驱动NPC（重要角色，深度对话）

## 💾 存档系统设计方案（基础版已实现，高级功能开发中）

### 🌍 核心理念：世界摄像头快照
整个游戏界面就像一个"世界摄像头"，存档 = 某一时刻的完整快照。刷新页面后世界会从断点继续运行。

### 存档类型（三层结构）
1. **自动存档 (Auto Save)** ✅部分实现
   - 每30秒自动保存（game-bootstrap实现）
   - 切换场景时自动保存 ✅
   - 只保留最新的1个 ✅
   - 存储位置：localStorage + `type: 'auto'`

2. **快速存档 (Quick Save)**
   - F5键或快捷按钮一键保存
   - 保留最近3个快速存档
   - 循环覆盖最旧的
   - 存储位置：`type: 'quick', slot: 0-2`

3. **手动存档 (Manual Save)**
   - 10个存档槽位
   - 可命名、可覆盖
   - 显示截图、时间、进度
   - 存储位置：`type: 'manual', slot: 0-9`

### 数据库结构
```javascript
// IndexedDB 数据库设计
db.stores({
    gameState: 'id',                        // 当前游戏状态
    saves: '++id, type, slot, timestamp',   // 存档数据表
    apiConfig: 'service',                   // API配置
    settings: 'key'                         // 游戏设置
});
```

### 存档数据格式
```javascript
{
    id: auto_increment,           // 自增ID
    type: 'auto/quick/manual',    // 存档类型
    slot: 0-9,                    // 槽位号
    name: '存档名称',              // 用户定义的名称
    timestamp: Date.now(),         // 保存时间戳

    // 游戏数据
    gameData: {
        character: {},             // 角色数据
        gameTime: {},              // 游戏时间
        location: '',              // 当前位置
        scene: '',                 // 当前场景
        chapter: 1,                // 章节进度
        playTime: 0,               // 游戏时长(秒)
        // ... 其他游戏数据
    },

    // 元数据
    metadata: {
        version: '1.0.0',          // 游戏版本
        screenshot: '',            // Base64截图(可选)
        description: ''            // 存档描述
    }
}
```

### 存档系统API
```javascript
// js/core/save-system.js
class SaveSystem {
    // 基础功能
    async createSave(type, slot, name)    // 创建存档
    async loadSave(saveId)                // 读取存档
    async deleteSave(saveId)              // 删除存档
    async getSavesList(type)              // 获取存档列表

    // 快捷功能
    async quickSave()                     // 快速存档
    async autoSave()                      // 自动存档

    // 高级功能
    async exportSave(saveId)              // 导出存档为JSON
    async importSave(file)                // 从文件导入存档
    async exportAllSaves()                // 导出所有存档

    // 工具功能
    validateSaveData(data)                // 验证存档格式
    getSaveInfo(saveId)                   // 获取存档信息
    renameSave(saveId, newName)          // 重命名存档
}
```

### UI界面规划
- **游戏内快捷栏**：F5快速存档、F9快速读档
- **D区设置标签页**：快速存档、存档管理入口
- **存档管理对话框**：完整的存档列表、创建/读取/删除
- **主菜单存档页**：继续游戏、载入存档、新游戏

### 实现状态

#### ✅ 已完成功能
1. **基础架构**
   - game-bootstrap启动引导系统
   - worldState世界状态管理器
   - 完整世界快照保存/恢复
   - 刷新后自动继续游戏（不会重置）

2. **界面保存**
   - A区立绘状态 ✅
   - B区时间位置 ✅
   - C区场景预览 ✅
   - D区所有面板 ✅
   - E区提醒消息 ✅
   - F区剧情内容 ✅

3. **引擎系统集成**
   - 时间系统 ✅
   - 天气系统 ✅
   - 经济系统 ✅
   - 种植系统 ✅
   - 战斗系统 ✅
   - 关系系统 ✅

4. **存档功能**
   - 自动存档（30秒+场景切换）✅
   - 自动存档读取（刷新页面时）✅
   - 手动存档创建 ✅
   - 手动存档读取 ⚠️（刚修复，需测试）
   - 快速存档创建 ✅
   - 快速存档读取 ⚠️（需验证）

#### ⏳ 待开发功能
1. **UI优化**
   - 存档槽位可视化界面
   - 存档截图缩略图
   - 覆盖确认对话框
   - 存档详情显示（进度/时长）

2. **高级功能**
   - 导入/导出完善
   - 云同步
   - 存档加密防作弊
   - 版本兼容升级

3. **菜单集成**
   - 主菜单继续游戏
   - 新游戏覆盖提示
   - 多存档切换

### 自动存档系统（简化版）

#### 核心机制
- **游戏内时间**：每天早上5:00自动存档（主要依赖）
- **备用保险**：超过30分钟没存档时触发（防止意外）

#### 其他触发点
1. **场景切换**：切换场景时存档（间隔：1分钟）
2. **重要选择**：做出重要选择后立即存档
3. **战斗胜利**：战斗结束后存档（间隔：30秒）
4. **页面卸载**：离开游戏页面前必定存档

#### 设计理念
- 简单可靠：主要依赖游戏内时间，不会判断失误
- 每个游戏日自动存档一次，既安全又不频繁
- 保留手动存档和快速存档供玩家主动使用

### 注意事项
- 所有页面共用同一套存档系统
- menu.html和game-main.html的存档必须互通
- 存档版本兼容性处理
- 存档损坏检测和修复

---

## 🌍 完整存档系统设计（待实现）

### 核心理念：世界快照
存档 = 游戏世界在某一时刻的完整快照，保存后继续游玩不中断

### 1. 分层存储架构

#### 层级1：核心数据（必须保存）
```javascript
core: {
    version: "1.0.0",
    character: {
        name, health, mood, money, energy, spirit,
        location, position
    },
    gameTime: { day, hour, minute },
    playTime: 12580 // 总游玩秒数
}
```

#### 层级2：世界系统
```javascript
world: {
    // 天气系统
    weather: { current, forecast, temperature },

    // 经济系统
    economy: {
        marketPrices,  // 只保存与默认不同的
        playerTransactions: [] // 最近交易
    },

    // 种植系统
    farming: {
        plots: [
            { id, crop, plantedDay, growth, watered }
        ],
        warehouse: { "tomato": 50, "wheat": 100 }
    }
}
```

#### 层级3：剧情进度
```javascript
story: {
    mainQuest: "chapter2_part3",

    // 关键剧情标记（布尔值省空间）
    flags: {
        "MET_ZERO": true,
        "WOLF_SOUL_REVEALED": true,
        "MEMORY_FRAGMENT_1": true
    },

    // NPC关系
    relationships: {
        "Zero": {
            affection: 75,
            trust: 60,
            stage: "friend"
        }
    }
}
```

#### 层级4：战斗系统
```javascript
combat: {
    // 永久数据（始终保存）
    permanent: {
        combatLevel: 5,
        unlockedSkills: [],
        statistics: {}
    },

    // 临时数据（战斗中才有）
    temporary: null, // 平时为null节省空间

    // 如果在战斗中：
    // temporary: {
    //     round: 5,
    //     player: { hp, trauma, stamina },
    //     enemies: [],
    //     environment: {}
    // }
}
```

#### 层级5：AI记忆（独立管理）
```javascript
aiMemory: {
    // 暂时简单实现，等API接入后优化
    "Zero": {
        dialogues: [], // 最近20条
        summary: ""    // 关系摘要
    }
}
```

### 2. 存储优化策略

#### 差异存储
- 只保存与默认值不同的数据
- 世界变化只记录改变的部分

#### 数据压缩
- 使用ID代替完整数据
- 布尔值用位掩码存储
- 历史记录限制数量

#### 分级保存
- 快速存档：只保存core + world.time
- 完整存档：保存所有数据
- 增量存档：只保存变化（未来）

### 3. 预计存档大小
- 非战斗状态：~40KB
- 战斗中：~50KB
- 包含AI记忆：~60KB

### 4. 实现优先级
1. ✅ 基础存档系统（已完成）
2. ⏳ 剧情标记系统（待实现）
3. ⏳ NPC关系系统（待实现）
4. ⏳ 世界系统（天气/经济/种植）（待实现）
5. ⏳ 战斗状态保存（待实现）
6. ⏳ AI记忆管理（等API接入后）

---

## 🎨 插图浮层系统（2024-12-28 新增）

### 概述
Reality游戏现已集成先进的插图浮层系统，支持两种显示模式：
1. **内嵌模式**：小型插图在F1区内显示（原有功能）
2. **浮层模式**：大型/重要插图以模态框展示（新增功能）

### 核心特性
- **智能切换**：根据插图类型自动选择显示方式
- **缩放功能**：点击图片放大/缩小查看
- **PWA优化**：支持触摸手势，移动端体验优秀
- **可扩展性**：框架可复用于手机界面、日记本、烹饪系统等

### 使用方法

#### 基础插图（内嵌显示）
```javascript
{
    emoji: '🏠',
    caption: '温馨的房间',
    description: '描述文字'
}
```

#### 浮层插图（模态框显示）
```javascript
{
    emoji: '🏥',
    caption: '神秘的房间',
    description: '详细描述',
    type: 'modal',      // 关键：标记为浮层模式
    title: '浮层标题',   // 模态框标题
    isLarge: true       // 可选：标记为大图
}
```

#### 真实图片（未来支持）
```javascript
{
    url: 'images/scene/lab.jpg',  // 图片路径
    caption: '实验室全景',
    type: 'modal',
    title: '场景图片'
}
```

### 技术实现
1. **HTML结构**：在game-main.html添加modal容器
2. **CSS样式**：260+行专业浮层样式（game-main.css第2614行起）
3. **JS逻辑**：扩展IllustrationManager类，新增showModal等方法
4. **数据配置**：在scene-illustrations.js中添加type标记

### 相关文件
- `/js/core/illustration-manager.js` - 插图管理器（含浮层方法）
- `/js/data/scene-illustrations.js` - 场景插图数据配置
- `/css/game-main.css` - 浮层样式（第2614-2866行）
- `/game-main.html` - 浮层HTML结构（第232-263行）
- `/插图浮层系统演示.html` - 独立演示文件

### 快捷操作
- **🔍 F2放大镜按钮**：查看当前场景插图
- **ESC键**：关闭浮层
- **点击背景**：关闭浮层
- **点击图片**：缩放查看

### 未来扩展方向
这个浮层框架设计为通用组件，可轻松扩展为：
- 📱 **手机界面**：显示短信、通话、应用
- 📖 **日记系统**：翻页效果、手写风格
- 🍳 **烹饪界面**：食谱步骤、动画效果
- 🗺️ **地图系统**：可缩放的世界地图
- 💼 **物品查看**：3D旋转、详细属性
- 🖥️ **电脑界面**：操作系统模拟
- 📸 **相册系统**：照片墙、回忆录

### 开发注意事项
1. 保持向后兼容：旧场景自动使用内嵌模式
2. 性能优化：大图使用懒加载
3. 移动适配：确保触摸手势流畅
4. 主题一致：使用游戏统一配色