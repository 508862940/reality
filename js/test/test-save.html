<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å­˜æ¡£ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        button { margin: 5px; padding: 10px; background: #8b92f6; border: none; color: white; cursor: pointer; }
        button:hover { background: #f093fb; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #444; }
        .log { background: #222; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ® å­˜æ¡£ç³»ç»Ÿæµ‹è¯•</h1>

    <div class="section">
        <h2>åœºæ™¯æµ‹è¯•</h2>
        <button onclick="createTestScene()">åˆ›å»ºæµ‹è¯•åœºæ™¯</button>
        <button onclick="saveWithScene()">ä¿å­˜ï¼ˆåŒ…å«åœºæ™¯ï¼‰</button>
        <button onclick="loadWithScene()">è¯»å–ï¼ˆæ¢å¤åœºæ™¯ï¼‰</button>
        <button onclick="clearScene()">æ¸…ç©ºåœºæ™¯</button>
    </div>

    <div class="section">
        <h2>å­˜æ¡£æ“ä½œ</h2>
        <button onclick="quickSave()">å¿«é€Ÿå­˜æ¡£ (F5)</button>
        <button onclick="autoSave()">è§¦å‘è‡ªåŠ¨å­˜æ¡£</button>
        <button onclick="manualSave()">æ‰‹åŠ¨å­˜æ¡£</button>
        <button onclick="listSaves()">åˆ—å‡ºæ‰€æœ‰å­˜æ¡£</button>
        <button onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰å­˜æ¡£</button>
    </div>

    <div class="section">
        <h2>å½“å‰çŠ¶æ€</h2>
        <pre id="currentState">ç­‰å¾…æ“ä½œ...</pre>
    </div>

    <div class="section">
        <h2>æ—¥å¿—è¾“å‡º</h2>
        <div class="log" id="log"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="../../lib/dexie.min.js"></script>
    <script src="../core/database.js"></script>
    <script src="../core/save-system.js"></script>
    <script src="../core/world-state.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'white';
            logEl.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // æ¨¡æ‹Ÿåœºæ™¯ç®¡ç†å™¨
        window.sceneManager = {
            currentScene: null,
            currentTextIndex: 0,
            isInChoice: false,
            displayScene: function(scene) {
                this.currentScene = scene;
                log('åœºæ™¯å·²æ˜¾ç¤º: ' + scene.id, 'success');
                updateState();
            }
        };

        // æ¨¡æ‹ŸF1åŒºåŸŸ
        document.body.innerHTML += '<div id="storyText" style="display:none"></div>';

        // åˆå§‹åŒ–
        async function init() {
            try {
                await Database.init();
                window.saveSystem = new SaveSystem();
                await window.saveSystem.init();
                window.worldState = new WorldState();
                log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error, 'error');
            }
        }

        // åˆ›å»ºæµ‹è¯•åœºæ™¯
        function createTestScene() {
            const testScene = {
                id: 'test_scene_' + Date.now(),
                texts: ['è¿™æ˜¯æµ‹è¯•åœºæ™¯çš„ç¬¬ä¸€æ®µæ–‡æœ¬', 'è¿™æ˜¯ç¬¬äºŒæ®µæ–‡æœ¬'],
                choices: [{
                    text: 'é€‰é¡¹A',
                    next: 'scene_a'
                }, {
                    text: 'é€‰é¡¹B',
                    next: 'scene_b'
                }]
            };

            window.sceneManager.currentScene = testScene;
            window.sceneManager.currentTextIndex = 1;
            window.sceneManager.isInChoice = true;

            // æ¨¡æ‹ŸF1åŒºåŸŸå†…å®¹
            document.getElementById('storyText').innerHTML = `
                <p>${testScene.texts[0]}</p>
                <p>${testScene.texts[1]}</p>
                <button>é€‰é¡¹A</button>
                <button>é€‰é¡¹B</button>
            `;

            log('æµ‹è¯•åœºæ™¯å·²åˆ›å»º: ' + testScene.id, 'success');
            updateState();
        }

        // ä¿å­˜ï¼ˆåŒ…å«åœºæ™¯ï¼‰
        async function saveWithScene() {
            try {
                const saveData = await window.saveSystem.createSave('manual', 0, 'æµ‹è¯•å­˜æ¡£');
                log('å­˜æ¡£æˆåŠŸï¼ŒID: ' + saveData.id, 'success');

                // æ£€æŸ¥æ˜¯å¦ä¿å­˜äº†åœºæ™¯
                const saved = await window.saveSystem.getSaveData(saveData.id);
                if (saved.gameData.worldData && saved.gameData.worldData.currentSceneData) {
                    log('âœ… åœºæ™¯æ•°æ®å·²ä¿å­˜', 'success');
                    log('åœºæ™¯ID: ' + saved.gameData.worldData.currentSceneData.scene.id, 'info');
                } else {
                    log('âŒ åœºæ™¯æ•°æ®æœªä¿å­˜', 'error');
                }
            } catch (error) {
                log('ä¿å­˜å¤±è´¥: ' + error, 'error');
            }
        }

        // è¯»å–ï¼ˆæ¢å¤åœºæ™¯ï¼‰
        async function loadWithScene() {
            try {
                // å…ˆæ¸…ç©ºå½“å‰åœºæ™¯
                clearScene();

                // è¯»å–å­˜æ¡£
                const saves = await window.saveSystem.getSavesList('manual');
                if (saves.length === 0) {
                    log('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£', 'error');
                    return;
                }

                const latestSave = saves[0];
                await window.saveSystem.loadSave(latestSave.id);

                log('å­˜æ¡£å·²åŠ è½½', 'success');

                // æ£€æŸ¥åœºæ™¯æ˜¯å¦æ¢å¤
                if (window.sceneManager.currentScene) {
                    log('âœ… åœºæ™¯å·²æ¢å¤: ' + window.sceneManager.currentScene.id, 'success');
                } else {
                    log('âŒ åœºæ™¯æœªæ¢å¤', 'error');
                }

                updateState();
            } catch (error) {
                log('è¯»å–å¤±è´¥: ' + error, 'error');
            }
        }

        // æ¸…ç©ºåœºæ™¯
        function clearScene() {
            window.sceneManager.currentScene = null;
            window.sceneManager.currentTextIndex = 0;
            window.sceneManager.isInChoice = false;
            document.getElementById('storyText').innerHTML = '';
            log('åœºæ™¯å·²æ¸…ç©º', 'info');
            updateState();
        }

        // å¿«é€Ÿå­˜æ¡£
        async function quickSave() {
            try {
                await window.saveSystem.quickSave();
                log('å¿«é€Ÿå­˜æ¡£æˆåŠŸ', 'success');
            } catch (error) {
                log('å¿«é€Ÿå­˜æ¡£å¤±è´¥: ' + error, 'error');
            }
        }

        // è‡ªåŠ¨å­˜æ¡£
        async function autoSave() {
            try {
                await window.saveSystem.autoSave();
                log('è‡ªåŠ¨å­˜æ¡£æˆåŠŸ', 'success');
            } catch (error) {
                log('è‡ªåŠ¨å­˜æ¡£å¤±è´¥: ' + error, 'error');
            }
        }

        // æ‰‹åŠ¨å­˜æ¡£
        async function manualSave() {
            const name = prompt('å­˜æ¡£åç§°ï¼š', 'æ‰‹åŠ¨å­˜æ¡£ ' + new Date().toLocaleTimeString());
            if (name) {
                try {
                    const slot = prompt('æ§½ä½ (0-9)ï¼š', '1');
                    await window.saveSystem.createSave('manual', parseInt(slot), name);
                    log('æ‰‹åŠ¨å­˜æ¡£æˆåŠŸ: ' + name, 'success');
                } catch (error) {
                    log('æ‰‹åŠ¨å­˜æ¡£å¤±è´¥: ' + error, 'error');
                }
            }
        }

        // åˆ—å‡ºæ‰€æœ‰å­˜æ¡£
        async function listSaves() {
            try {
                const saves = await window.saveSystem.getSavesList();
                log('æ‰¾åˆ° ' + saves.length + ' ä¸ªå­˜æ¡£:', 'info');
                saves.forEach(save => {
                    log(`[${save.type}] ${save.name} - ${new Date(save.timestamp).toLocaleString()}`, 'info');
                });
            } catch (error) {
                log('åˆ—å‡ºå­˜æ¡£å¤±è´¥: ' + error, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å­˜æ¡£
        async function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜æ¡£å—ï¼Ÿ')) {
                try {
                    const saves = await window.saveSystem.getSavesList();
                    for (const save of saves) {
                        await window.saveSystem.deleteSave(save.id);
                    }
                    log('å·²æ¸…ç©ºæ‰€æœ‰å­˜æ¡£', 'success');
                } catch (error) {
                    log('æ¸…ç©ºå¤±è´¥: ' + error, 'error');
                }
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateState() {
            const state = {
                scene: window.sceneManager.currentScene ? {
                    id: window.sceneManager.currentScene.id,
                    textIndex: window.sceneManager.currentTextIndex,
                    inChoice: window.sceneManager.isInChoice
                } : null,
                worldState: window.worldState ? {
                    player: window.worldState.state.player.name,
                    location: window.worldState.state.player.position.location,
                    time: window.worldState.state.time
                } : null
            };
            document.getElementById('currentState').textContent = JSON.stringify(state, null, 2);
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>