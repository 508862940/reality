<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>存档系统测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        button { margin: 5px; padding: 10px; background: #8b92f6; border: none; color: white; cursor: pointer; }
        button:hover { background: #f093fb; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #444; }
        .log { background: #222; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🎮 存档系统测试</h1>

    <div class="section">
        <h2>场景测试</h2>
        <button onclick="createTestScene()">创建测试场景</button>
        <button onclick="saveWithScene()">保存（包含场景）</button>
        <button onclick="loadWithScene()">读取（恢复场景）</button>
        <button onclick="clearScene()">清空场景</button>
    </div>

    <div class="section">
        <h2>存档操作</h2>
        <button onclick="quickSave()">快速存档 (F5)</button>
        <button onclick="autoSave()">触发自动存档</button>
        <button onclick="manualSave()">手动存档</button>
        <button onclick="listSaves()">列出所有存档</button>
        <button onclick="clearAll()">清空所有存档</button>
    </div>

    <div class="section">
        <h2>当前状态</h2>
        <pre id="currentState">等待操作...</pre>
    </div>

    <div class="section">
        <h2>日志输出</h2>
        <div class="log" id="log"></div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="../../lib/dexie.min.js"></script>
    <script src="../core/database.js"></script>
    <script src="../core/save-system.js"></script>
    <script src="../core/world-state.js"></script>

    <script>
        // 日志函数
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'white';
            logEl.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // 模拟场景管理器
        window.sceneManager = {
            currentScene: null,
            currentTextIndex: 0,
            isInChoice: false,
            displayScene: function(scene) {
                this.currentScene = scene;
                log('场景已显示: ' + scene.id, 'success');
                updateState();
            }
        };

        // 模拟F1区域
        document.body.innerHTML += '<div id="storyText" style="display:none"></div>';

        // 初始化
        async function init() {
            try {
                await Database.init();
                window.saveSystem = new SaveSystem();
                await window.saveSystem.init();
                window.worldState = new WorldState();
                log('系统初始化完成', 'success');
            } catch (error) {
                log('初始化失败: ' + error, 'error');
            }
        }

        // 创建测试场景
        function createTestScene() {
            const testScene = {
                id: 'test_scene_' + Date.now(),
                texts: ['这是测试场景的第一段文本', '这是第二段文本'],
                choices: [{
                    text: '选项A',
                    next: 'scene_a'
                }, {
                    text: '选项B',
                    next: 'scene_b'
                }]
            };

            window.sceneManager.currentScene = testScene;
            window.sceneManager.currentTextIndex = 1;
            window.sceneManager.isInChoice = true;

            // 模拟F1区域内容
            document.getElementById('storyText').innerHTML = `
                <p>${testScene.texts[0]}</p>
                <p>${testScene.texts[1]}</p>
                <button>选项A</button>
                <button>选项B</button>
            `;

            log('测试场景已创建: ' + testScene.id, 'success');
            updateState();
        }

        // 保存（包含场景）
        async function saveWithScene() {
            try {
                const saveData = await window.saveSystem.createSave('manual', 0, '测试存档');
                log('存档成功，ID: ' + saveData.id, 'success');

                // 检查是否保存了场景
                const saved = await window.saveSystem.getSaveData(saveData.id);
                if (saved.gameData.worldData && saved.gameData.worldData.currentSceneData) {
                    log('✅ 场景数据已保存', 'success');
                    log('场景ID: ' + saved.gameData.worldData.currentSceneData.scene.id, 'info');
                } else {
                    log('❌ 场景数据未保存', 'error');
                }
            } catch (error) {
                log('保存失败: ' + error, 'error');
            }
        }

        // 读取（恢复场景）
        async function loadWithScene() {
            try {
                // 先清空当前场景
                clearScene();

                // 读取存档
                const saves = await window.saveSystem.getSavesList('manual');
                if (saves.length === 0) {
                    log('没有找到存档', 'error');
                    return;
                }

                const latestSave = saves[0];
                await window.saveSystem.loadSave(latestSave.id);

                log('存档已加载', 'success');

                // 检查场景是否恢复
                if (window.sceneManager.currentScene) {
                    log('✅ 场景已恢复: ' + window.sceneManager.currentScene.id, 'success');
                } else {
                    log('❌ 场景未恢复', 'error');
                }

                updateState();
            } catch (error) {
                log('读取失败: ' + error, 'error');
            }
        }

        // 清空场景
        function clearScene() {
            window.sceneManager.currentScene = null;
            window.sceneManager.currentTextIndex = 0;
            window.sceneManager.isInChoice = false;
            document.getElementById('storyText').innerHTML = '';
            log('场景已清空', 'info');
            updateState();
        }

        // 快速存档
        async function quickSave() {
            try {
                await window.saveSystem.quickSave();
                log('快速存档成功', 'success');
            } catch (error) {
                log('快速存档失败: ' + error, 'error');
            }
        }

        // 自动存档
        async function autoSave() {
            try {
                await window.saveSystem.autoSave();
                log('自动存档成功', 'success');
            } catch (error) {
                log('自动存档失败: ' + error, 'error');
            }
        }

        // 手动存档
        async function manualSave() {
            const name = prompt('存档名称：', '手动存档 ' + new Date().toLocaleTimeString());
            if (name) {
                try {
                    const slot = prompt('槽位 (0-9)：', '1');
                    await window.saveSystem.createSave('manual', parseInt(slot), name);
                    log('手动存档成功: ' + name, 'success');
                } catch (error) {
                    log('手动存档失败: ' + error, 'error');
                }
            }
        }

        // 列出所有存档
        async function listSaves() {
            try {
                const saves = await window.saveSystem.getSavesList();
                log('找到 ' + saves.length + ' 个存档:', 'info');
                saves.forEach(save => {
                    log(`[${save.type}] ${save.name} - ${new Date(save.timestamp).toLocaleString()}`, 'info');
                });
            } catch (error) {
                log('列出存档失败: ' + error, 'error');
            }
        }

        // 清空所有存档
        async function clearAll() {
            if (confirm('确定要清空所有存档吗？')) {
                try {
                    const saves = await window.saveSystem.getSavesList();
                    for (const save of saves) {
                        await window.saveSystem.deleteSave(save.id);
                    }
                    log('已清空所有存档', 'success');
                } catch (error) {
                    log('清空失败: ' + error, 'error');
                }
            }
        }

        // 更新状态显示
        function updateState() {
            const state = {
                scene: window.sceneManager.currentScene ? {
                    id: window.sceneManager.currentScene.id,
                    textIndex: window.sceneManager.currentTextIndex,
                    inChoice: window.sceneManager.isInChoice
                } : null,
                worldState: window.worldState ? {
                    player: window.worldState.state.player.name,
                    location: window.worldState.state.player.position.location,
                    time: window.worldState.state.time
                } : null
            };
            document.getElementById('currentState').textContent = JSON.stringify(state, null, 2);
        }

        // 初始化
        init();
    </script>
</body>
</html>