<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>我的互动小说游戏</title>
    
    <!-- iPhone 15 适配 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="互动小说">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- 防止iOS缩放 -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWA配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23667eea'/%3E%3Ctext x='90' y='95' text-anchor='middle' fill='white' font-size='20' font-family='Arial'%3E互动%3C/text%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="game-container">
        <!-- 游戏标题 -->
        <header id="game-header">
            <h1>我的互动小说游戏</h1>
        </header>

        <!-- 角色状态面板 -->
        <div id="character-panel">
            <div class="stat">
                <span class="stat-name">体力:</span>
                <span id="health" class="stat-value">100</span>
            </div>
            <div class="stat">
                <span class="stat-name">心情:</span>
                <span id="mood" class="stat-value">50</span>
            </div>
            <div class="stat">
                <span class="stat-name">金钱:</span>
                <span id="money" class="stat-value">100</span>
            </div>
        </div>

        <!-- 游戏主界面 -->
        <main id="game-main">
            <!-- 地点显示 -->
            <div id="location-display">
                <h2 id="current-location">学校</h2>
                <p id="location-description">你站在学校的大门前，可以看到教学楼和操场。</p>
            </div>

            <!-- 互动选项 -->
            <div id="interaction-options">
                <button class="option-btn" onclick="goToLocation('classroom')">进入教室</button>
                <button class="option-btn" onclick="goToLocation('playground')">去操场</button>
                <button class="option-btn" onclick="goToLocation('cafeteria')">去食堂</button>
            </div>

            <!-- AI互动按钮 -->
            <div id="ai-interaction-area">
                <button class="ai-btn" onclick="openAIChat()">与AI对话</button>
                <button class="ai-btn" onclick="generateAIEvent()">AI生成事件</button>
                <button class="ai-btn" onclick="toggleAISettings()">AI设置</button>
            </div>

            <!-- 对话/事件显示 -->
            <div id="event-display">
                <p id="event-text">欢迎来到游戏！选择一个地点开始探索吧。</p>
            </div>
        </main>
    </div>

    <!-- AI聊天界面 -->
    <div id="ai-chat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ai-npc-name">AI助手</h3>
                <span class="close" onclick="closeAIChat()">&times;</span>
            </div>
            <div id="ai-chat-messages" class="chat-messages">
                <!-- AI对话消息将显示在这里 -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="ai-chat-input" placeholder="输入消息..." onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- AI设置面板 -->
    <div id="ai-settings-panel" class="settings-panel">
        <h3>AI设置</h3>
        
        <!-- AI服务选择 -->
        <div class="setting-item">
            <label for="ai-provider-select">AI服务:</label>
            <select id="ai-provider-select" onchange="changeAIProvider()">
                <option value="openai_proxy">OpenAI兼容代理 (推荐)</option>
                <option value="openai">OpenAI GPT</option>
                <option value="gemini">Google Gemini</option>
                <option value="claude">Anthropic Claude</option>
                <option value="local">本地AI (Ollama)</option>
            </select>
        </div>
        
        <!-- OpenAI兼容代理配置 -->
        <div id="openai-proxy-config" class="proxy-config">
            <div class="setting-item">
                <label for="proxy-url-input">代理地址:</label>
                <input type="url" id="proxy-url-input" placeholder="https://your-proxy.com/v1">
                <small>输入你的OpenAI兼容代理的完整URL</small>
            </div>
            <div class="setting-item">
                <label for="proxy-key-input">API密钥:</label>
                <input type="password" id="proxy-key-input" placeholder="输入API密钥">
                <small>你的代理服务提供的API密钥</small>
            </div>
            <div class="setting-item">
                <label for="proxy-model-select">模型:</label>
                <div class="model-select-container">
                    <select id="proxy-model-select" onchange="handleModelSelect()">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4">gpt-4</option>
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4o-mini">gpt-4o-mini</option>
                        <option value="claude-3-sonnet-20240229">claude-3-sonnet-20240229</option>
                        <option value="claude-3-opus-20240229">claude-3-opus-20240229</option>
                        <option value="claude-3-haiku-20240307">claude-3-haiku-20240307</option>
                        <option value="custom">自定义模型...</option>
                    </select>
                    <input type="text" id="custom-model-input" placeholder="输入自定义模型名称" class="custom-model-input">
                </div>
                <small>选择要使用的模型，或输入自定义模型名称</small>
            </div>
        </div>
        
        <!-- 其他API配置 -->
        <div id="other-api-config" class="other-config">
            <div class="setting-item">
                <label for="api-key-input">API密钥:</label>
                <input type="password" id="api-key-input" placeholder="输入API密钥">
            </div>
        </div>
        
        <!-- 高级设置 -->
        <div class="setting-item">
            <label for="temperature-slider">创造性 (0-1):</label>
            <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.8">
            <span id="temperature-value">0.8</span>
            <small>数值越高，AI回应越有创造性</small>
        </div>
        
        <div class="setting-item">
            <label for="max-tokens-input">最大回复长度:</label>
            <input type="number" id="max-tokens-input" min="50" max="500" value="200">
            <small>控制AI回复的长度</small>
        </div>
        
        <!-- 操作按钮 -->
        <div class="setting-buttons">
            <button onclick="saveAISettings()" class="save-btn">保存设置</button>
            <button onclick="testAIConnection()" class="test-btn">测试连接</button>
            <button onclick="resetAISettings()" class="reset-btn">重置设置</button>
        </div>
        
        <!-- 状态显示 -->
        <div id="ai-status" class="ai-status">
            <span id="status-text">未配置</span>
        </div>
    </div>

    <script src="ai-config.js"></script>
    <script src="ai-npc-system.js"></script>
    <script src="game.js"></script>
    
    <!-- PWA Service Worker注册 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // 移动端触摸优化 - 最小化干预
        document.addEventListener('touchstart', function() {}, true);
        
        // 只处理页面边缘的过度滚动，不影响正常交互
        let startY = 0;
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].pageY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].pageY;
            const deltaY = currentY - startY;
            
            // 只在页面顶部向上滑动或底部向下滑动时阻止
            const isAtTop = window.pageYOffset <= 0;
            const isAtBottom = window.pageYOffset + window.innerHeight >= document.body.scrollHeight;
            
            if ((isAtTop && deltaY > 0) || (isAtBottom && deltaY < 0)) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>

