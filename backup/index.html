<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æˆ‘çš„äº’åŠ¨å°è¯´æ¸¸æˆ</title>
    
    <!-- iPhone 15 é€‚é… -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="äº’åŠ¨å°è¯´">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- é˜²æ­¢iOSç¼©æ”¾ -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23667eea'/%3E%3Ctext x='90' y='95' text-anchor='middle' fill='white' font-size='20' font-family='Arial'%3Eäº’åŠ¨%3C/text%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="game-container">
        <!-- æ¸¸æˆæ ‡é¢˜ -->
        <header id="game-header">
            <h1>æˆ‘çš„äº’åŠ¨å°è¯´æ¸¸æˆ</h1>
        </header>

        <!-- è§’è‰²çŠ¶æ€é¢æ¿ -->
        <div id="character-panel">
            <div class="stat">
                <span class="stat-name">ä½“åŠ›:</span>
                <span id="health" class="stat-value">100</span>
            </div>
            <div class="stat">
                <span class="stat-name">å¿ƒæƒ…:</span>
                <span id="mood" class="stat-value">50</span>
            </div>
            <div class="stat">
                <span class="stat-name">é‡‘é’±:</span>
                <span id="money" class="stat-value">100</span>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <main id="game-main">
            <!-- åœ°ç‚¹æ˜¾ç¤º -->
            <div id="location-display">
                <h2 id="current-location">å­¦æ ¡</h2>
                <p id="location-description">ä½ ç«™åœ¨å­¦æ ¡çš„å¤§é—¨å‰ï¼Œå¯ä»¥çœ‹åˆ°æ•™å­¦æ¥¼å’Œæ“åœºã€‚</p>
            </div>

            <!-- äº’åŠ¨é€‰é¡¹ -->
            <div id="interaction-options">
                <button class="option-btn" onclick="goToLocation('classroom')">è¿›å…¥æ•™å®¤</button>
                <button class="option-btn" onclick="goToLocation('playground')">å»æ“åœº</button>
                <button class="option-btn" onclick="goToLocation('cafeteria')">å»é£Ÿå ‚</button>
            </div>

            <!-- AIäº’åŠ¨æŒ‰é’® -->
            <div id="ai-interaction-area">
                <button class="ai-btn" onclick="openAIChat()">ä¸AIå¯¹è¯</button>
                <button class="ai-btn" onclick="generateAIEvent()">AIç”Ÿæˆäº‹ä»¶</button>
                <button class="ai-btn" onclick="toggleAISettings()">AIè®¾ç½®</button>
            </div>

            <!-- å¯¹è¯/äº‹ä»¶æ˜¾ç¤º -->
            <div id="event-display">
                <p id="event-text">æ¬¢è¿æ¥åˆ°æ¸¸æˆï¼é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹å¼€å§‹æ¢ç´¢å§ã€‚</p>
            </div>
        </main>
    </div>

    <!-- APIè®¾ç½®ç•Œé¢ -->
    <div id="api-settings-panel" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ğŸ”§ APIè®¾ç½®</h2>
                <span class="close-btn" onclick="closeAPISettings()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- é¢„è®¾é€‰æ‹© -->
                <div class="form-group">
                    <label for="api-preset-select">APIé¢„è®¾</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="api-preset-select" style="flex: 1;"></select>
                        <button id="add-preset-btn" class="preset-btn">+</button>
                        <button id="delete-preset-btn" class="preset-btn">-</button>
                    </div>
                </div>
                <hr class="separator">

                <!-- é¢„è®¾é…ç½® -->
                <div class="form-group">
                    <label for="preset-name-input">é¢„è®¾åç§°</label>
                    <input type="text" id="preset-name-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„API">
                </div>
                <div class="form-group">
                    <label for="api-provider-select">API æœåŠ¡å•†</label>
                    <select id="api-provider-select">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                        <option value="openai-compatible">OpenAI å…¼å®¹ (ä¸­è½¬)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">API åœ°å€ / ä¸­è½¬ç«™</label>
                    <input type="text" id="api-endpoint-input" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="api-key-input">API å¯†é’¥</label>
                    <input type="password" id="api-key-input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å¯†é’¥">
                </div>
                <div class="form-group">
                    <label for="api-model-input">æ¨¡å‹åç§°</label>
                    <div style="position: relative;">
                        <input list="api-models-list" id="api-model-input" name="model" placeholder="ç‚¹å‡»é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥..." autocomplete="off">
                        <select id="api-model-select" style="position: absolute; top: 0; left: 0; width: 100%; opacity: 0; cursor: pointer;" onchange="document.getElementById('api-model-input').value = this.value;">
                            <option value="">é€‰æ‹©æ¨¡å‹...</option>
                            <optgroup label="OpenAI / å…¼å®¹">
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                <option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>
                                <option value="gpt-4">gpt-4</option>
                                <option value="gpt-4-turbo">gpt-4-turbo</option>
                                <option value="gpt-4o">gpt-4o</option>
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </optgroup>
                            <optgroup label="Google Gemini">
                                <option value="gemini-pro">gemini-pro</option>
                                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            </optgroup>
                            <optgroup label="Claude">
                                <option value="claude-3-sonnet">claude-3-sonnet</option>
                                <option value="claude-3-opus">claude-3-opus</option>
                                <option value="claude-3-haiku">claude-3-haiku</option>
                            </optgroup>
                            <optgroup label="å›½äº§æ¨¡å‹">
                                <option value="qwen-turbo">qwen-turbo (é€šä¹‰åƒé—®)</option>
                                <option value="qwen-plus">qwen-plus (é€šä¹‰åƒé—®)</option>
                                <option value="moonshot-v1-8k">moonshot-v1-8k (æœˆä¹‹æš—é¢)</option>
                                <option value="glm-4">glm-4 (æ™ºè°±)</option>
                            </optgroup>
                        </select>
                        <datalist id="api-models-list"></datalist>
                    </div>
                    <small style="color: #666; font-size: 12px;">å¯ä»¥ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥å…¶ä»–æ¨¡å‹åç§°</small>
                </div>
                <div class="button-group">
                    <button id="save-preset-btn" class="btn-success">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨</button>
                    <button id="test-preset-btn" class="btn-info">ğŸ§ª æµ‹è¯•API</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIèŠå¤©ç•Œé¢ -->
    <div id="ai-chat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ai-npc-name">AIåŠ©æ‰‹</h3>
                <span class="close" onclick="closeAIChat()">&times;</span>
            </div>
            <div id="ai-chat-messages" class="chat-messages">
                <!-- AIå¯¹è¯æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="ai-chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- æ—§çš„AIè®¾ç½®é¢æ¿ï¼ˆå·²åºŸå¼ƒï¼‰ -->
    <div id="old-ai-settings-panel" class="settings-panel" style="display: none;">
        <h3>AIè®¾ç½®</h3>
        
        <!-- AIæœåŠ¡é€‰æ‹© -->
        <div class="setting-item">
            <label for="ai-provider-select">AIæœåŠ¡:</label>
            <select id="ai-provider-select" onchange="changeAIProvider()">
                <option value="openai_proxy">OpenAIå…¼å®¹ä»£ç† (æ¨è)</option>
                <option value="openai">OpenAI GPT</option>
                <option value="gemini">Google Gemini</option>
                <option value="claude">Anthropic Claude</option>
                <option value="local">æœ¬åœ°AI (Ollama)</option>
            </select>
        </div>
        
        <!-- OpenAIå…¼å®¹ä»£ç†é…ç½® -->
        <div id="openai-proxy-config" class="proxy-config">
            <div class="setting-item">
                <label for="proxy-url-input">ä»£ç†åœ°å€:</label>
                <input type="url" id="proxy-url-input" placeholder="https://your-proxy.com/v1">
                <small>è¾“å…¥ä½ çš„OpenAIå…¼å®¹ä»£ç†çš„å®Œæ•´URL</small>
            </div>
            <div class="setting-item">
                <label for="proxy-key-input">APIå¯†é’¥:</label>
                <input type="password" id="proxy-key-input" placeholder="è¾“å…¥APIå¯†é’¥">
                <small>ä½ çš„ä»£ç†æœåŠ¡æä¾›çš„APIå¯†é’¥</small>
            </div>
            <div class="setting-item">
                <label for="proxy-model-select">æ¨¡å‹:</label>
                <div class="model-select-container">
                    <select id="proxy-model-select" onchange="handleModelSelect()">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4">gpt-4</option>
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4o-mini">gpt-4o-mini</option>
                        <option value="claude-3-sonnet-20240229">claude-3-sonnet-20240229</option>
                        <option value="claude-3-opus-20240229">claude-3-opus-20240229</option>
                        <option value="claude-3-haiku-20240307">claude-3-haiku-20240307</option>
                        <option value="custom">è‡ªå®šä¹‰æ¨¡å‹...</option>
                    </select>
                    <input type="text" id="custom-model-input" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°" class="custom-model-input">
                </div>
                <small>é€‰æ‹©è¦ä½¿ç”¨çš„æ¨¡å‹ï¼Œæˆ–è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°</small>
            </div>
        </div>

        <!-- å…¶ä»–APIé…ç½® -->
        <div id="other-api-config" class="other-config">
            <div class="setting-item">
                <label for="ai-settings-key-input">APIå¯†é’¥:</label>
                <input type="password" id="ai-settings-key-input" placeholder="è¾“å…¥APIå¯†é’¥">
            </div>
        </div>
        
        <!-- è·å–æ¨¡å‹æŒ‰é’® - å§‹ç»ˆæ˜¾ç¤º -->
        <button id="fetch-models-btn" onclick="fetchAvailableModels()" class="fetch-models-btn">è·å–å¯ç”¨æ¨¡å‹</button>
        
        <!-- é«˜çº§è®¾ç½® -->
        <div class="setting-item">
            <label for="temperature-slider">åˆ›é€ æ€§ (0-1):</label>
            <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.8">
            <span id="temperature-value">0.8</span>
            <small>æ•°å€¼è¶Šé«˜ï¼ŒAIå›åº”è¶Šæœ‰åˆ›é€ æ€§</small>
        </div>
        
        <div class="setting-item">
            <label for="max-tokens-input">æœ€å¤§å›å¤é•¿åº¦:</label>
            <input type="number" id="max-tokens-input" min="50" max="500" value="200">
            <small>æ§åˆ¶AIå›å¤çš„é•¿åº¦</small>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="setting-buttons">
            <button onclick="saveAISettings()" class="save-btn">ä¿å­˜è®¾ç½®</button>
            <button onclick="testAIConnection()" class="test-btn">æµ‹è¯•è¿æ¥</button>
            <button onclick="resetAISettings()" class="reset-btn">é‡ç½®è®¾ç½®</button>
        </div>
        
        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="ai-status" class="ai-status">
            <span id="status-text">æœªé…ç½®</span>
        </div>
    </div>

    <script src="js/api-state.js"></script>
    <script src="ai-config.js"></script>
    <script src="ai-npc-system.js"></script>
    <script src="game.js"></script>
    <script src="js/api-settings-ui.js"></script>
    
    <!-- PWA Service Workeræ³¨å†Œ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– - æ¨¡æ€æ¡†æ»šåŠ¨ä¼˜å…ˆçº§ç®¡ç†
        let isModalOpen = false;
        
        // æ£€æµ‹æ¨¡æ€æ¡†çŠ¶æ€
        function updateModalState() {
            const settingsPanel = document.getElementById('ai-settings-panel');
            const chatModal = document.getElementById('ai-chat-modal');
            const modalBackdrop = document.querySelector('.modal');
            isModalOpen = settingsPanel.style.display === 'block' || 
                         chatModal.style.display === 'block' ||
                         (modalBackdrop && modalBackdrop.style.display === 'block');
            
            // åŠ¨æ€æ§åˆ¶bodyæ»šåŠ¨
            if (isModalOpen) {
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.top = `-${window.pageYOffset}px`;
            } else {
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                const scrollTop = document.body.style.top;
                document.body.style.top = '';
                if (scrollTop) {
                    window.scrollTo(0, parseInt(scrollTop || '0') * -1);
                }
            }
        }
        
        // ç›‘å¬æ¨¡æ€æ¡†æ˜¾ç¤º/éšè—
        const observer = new MutationObserver(updateModalState);
        observer.observe(document.getElementById('ai-settings-panel'), { attributes: true, attributeFilter: ['style'] });
        observer.observe(document.getElementById('ai-chat-modal'), { attributes: true, attributeFilter: ['style'] });
        
        // ç›‘å¬æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                updateModalState();
            }
        });
        
        // è§¦æ‘¸äº‹ä»¶å¤„ç† - æ¨¡æ€æ¡†å†…æ»šåŠ¨ä¼˜å…ˆ
        let startY = 0;
        let startX = 0;
        
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].pageY;
            startX = e.touches[0].pageX;
            updateModalState();
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            updateModalState();
            
            // å¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æ¨¡æ€æ¡†å†…æ»šåŠ¨
            if (isModalOpen) {
                const target = e.target;
                const isInModal = target.closest('.modal-content') || 
                                 target.closest('.settings-panel') ||
                                 target.closest('.chat-messages');
                
                if (!isInModal) {
                    // ä¸åœ¨æ¨¡æ€æ¡†å†…ï¼Œé˜»æ­¢æ»šåŠ¨
                    e.preventDefault();
                    return;
                }
                
                // åœ¨æ¨¡æ€æ¡†å†…ï¼Œæ£€æŸ¥æ»šåŠ¨å®¹å™¨
                const scrollContainer = target.closest('.settings-panel, .chat-messages, .modal-content');
                if (scrollContainer) {
                    const scrollTop = scrollContainer.scrollTop;
                    const scrollHeight = scrollContainer.scrollHeight;
                    const clientHeight = scrollContainer.clientHeight;
                    const deltaY = e.touches[0].pageY - startY;
                    
                    // å¦‚æœå·²ç»åˆ°é¡¶éƒ¨æˆ–åº•éƒ¨ï¼Œé˜»æ­¢è¿‡åº¦æ»šåŠ¨
                    if ((scrollTop <= 0 && deltaY > 0) || 
                        (scrollTop >= scrollHeight - clientHeight && deltaY < 0)) {
                        e.preventDefault();
                        return;
                    }
                }
            } else {
                // æ¨¡æ€æ¡†æœªæ‰“å¼€ï¼Œå¤„ç†ä¸»é¡µé¢çš„è¾¹ç¼˜æ»šåŠ¨
                const currentY = e.touches[0].pageY;
                const deltaY = currentY - startY;
                
                const isAtTop = window.pageYOffset <= 0;
                const isAtBottom = window.pageYOffset + window.innerHeight >= document.body.scrollHeight;
                
                if ((isAtTop && deltaY > 0) || (isAtBottom && deltaY < 0)) {
                    e.preventDefault();
                }
            }
        }, { passive: false });
    </script>
</body>
</html>

